name: Full Accessibility Test (WCAG 2.2)

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  accessibility:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install puppeteer axe-core pa11y lighthouse chrome-launcher

      - name: Extract URLs from sitemap
        run: |
          # ... same python script as before to produce urls.txt ...

      - name: Run Accessibility Tests
        run: |
          mkdir -p reports/raw
          node << 'EOF'
          const fs = require('fs');
          const puppeteer = require('puppeteer');
          const axe = require('axe-core');
          const pa11y = require('pa11y');
          const lighthouse = require('lighthouse');
          const chromeLauncher = require('chrome-launcher');

          (async () => {
            const urls = fs.readFileSync('urls.txt', 'utf8').trim().split('\n');
            const browser = await puppeteer.launch({
              headless: true,
              executablePath: '/usr/bin/chromium-browser',
              args: ['--no-sandbox','--disable-setuid-sandbox']
            });
            const page = await browser.newPage();

            let html = `<html> ... same html header ...`;

            for (const url of urls) {
              console.log("Processing:", url);
              html += `<h2>${url}</h2>`;
              try {
                // AXE
                await page.goto(url, { waitUntil: 'networkidle2' });
                await page.addScriptTag({ content: axe.source });
                const axeResults = await page.evaluate(async () =>
                  await axe.run({ runOnly: { type: 'tag', values: ['wcag22'] } })
                );
                fs.writeFileSync(`reports/raw/${encodeURIComponent(url)}-axe.json`, JSON.stringify(axeResults,null,2));
                const axeCount = axeResults.violations.length;

                // Pa11y
                const pa11yResults = await pa11y(url, { standard: 'WCAG2AA', runners: ['axe'] });
                fs.writeFileSync(`reports/raw/${encodeURIComponent(url)}-pa11y.json`, JSON.stringify(pa11yResults,null,2));
                const pa11yCount = pa11yResults.issues.length;

                // Lighthouse
                const chrome = await chromeLauncher.launch({
                  chromePath: '/usr/bin/chromium-browser',
                  chromeFlags: ['--headless','--no-sandbox','--disable-setuid-sandbox']
                });
                const lhOptions = { logLevel: 'error', output: 'json', port: chrome.port };
                const lhResult = await lighthouse(url, lhOptions);
                const score = Math.round(lhResult.lhr.categories.accessibility.score * 100);
                await chrome.kill();
                fs.writeFileSync(`reports/raw/${encodeURIComponent(url)}-lighthouse.json`, JSON.stringify(lhResult.lhr,null,2));

                html += `... table with results ...`;
              } catch (err) {
                console.error("Error processing URL:", url, err);
                html += `<p style="color:red;">Error processing this URL: ${err.message}</p>`;
              }
            }

            html += `</body></html>`;
            fs.writeFileSync('reports/a11y-report.html', html);
            await browser.close();
          })();
          EOF

      - name: Commit Reports
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add reports/
          if git diff --cached --quiet; then
            echo "No report changes."
          else
            git commit -m "â™¿ Update Accessibility Report (Axe + Pa11y WCAG2.2 + Lighthouse) [skip ci]"
            git push
